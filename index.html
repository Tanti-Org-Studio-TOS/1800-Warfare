
<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>á€™á€¼á€±á€¬á€€á€ºá€¡á€™á€±á€›á€­á€€ ááˆá€á€ â€” RTS + TBS Strategy</title>

  <!-- âœ… Leaflet CSS (CDN) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity=""
    crossorigin=""
  />

  <style>
    :root {
      --bg: #ffffff;
      --text: #1c1c1c;
      --card: #f5f5f7;
      --border: #dadada;
      --accent: #0057ff;
      --accent-2: #0f9d58;
      --danger: #e63946;
      --ok: #2a9d8f;
    }
    body[data-theme="dark"] {
      --bg: #0f1115;
      --text: #eaeaea;
      --card: #171a21;
      --border: #2a2e37;
      --accent: #5aa1ff;
      --accent-2: #34a853;
      --danger: #ef476f;
      --ok: #06d6a0;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, "Myanmar Khyay", "Myanmar Sangam MN", "Noto Sans Myanmar", Roboto, Arial, sans-serif;
    }
    .topbar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 12px; border-bottom: 1px solid var(--border); background: var(--card);
      position: sticky; top: 0; z-index: 1000;
    }
    .brand { display: flex; align-items: center; gap: 8px; }
    .controls > * { margin-left: 8px; }
    .switch { display: inline-flex; align-items: center; gap: 6px; }
    .file-label {
      display: inline-flex; align-items: center; gap: 6px;
      background: var(--card); border: 1px dashed var(--border);
      padding: 4px 8px; border-radius: 6px; cursor: pointer;
    }
    .file-label input { display: none; }
    main {
      display: grid; grid-template-columns: 360px 1fr;
      height: calc(100vh - 56px);
    }
    #sidebar { overflow: auto; border-right: 1px solid var(--border); background: var(--bg); }
    .panel { padding: 12px; border-bottom: 1px solid var(--border); }
    .panel h3 { margin: 0 0 8px; }
    /* âœ… Map must have height */
    #map { height: 100%; width: 100%; }
    button, select, input {
      color: var(--text); background: var(--card); border: 1px solid var(--border);
      border-radius: 6px; padding: 6px 8px;
    }
    button:hover { border-color: var(--accent); }
    .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn-danger { background: var(--danger); color: #fff; border-color: var(--danger); }
    .btn-ok { background: var(--ok); color: #fff; border-color: var(--ok); }
    #legend { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .legend-item { display: flex; align-items: center; gap: 8px; }
    .swatch { width: 16px; height: 16px; border-radius: 3px; border: 1px solid var(--border); }
    .city-badge { background: var(--accent-2); color: white; padding: 2px 6px; border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.2); font-size: 12px; }
    .unit-badge { background: var(--accent); color: white; padding: 2px 6px; border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.2); font-size: 12px; }
    .progress { width: 100%; height: 8px; background: var(--card); border: 1px solid var(--border);
      border-radius: 4px; overflow: hidden; margin-top: 4px; }
    .progress > span { display: block; height: 100%; background: var(--accent); width: 0%; }
    .flex { display: flex; gap: 8px; align-items: center; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    footer { padding: 6px 12px; border-top: 1px solid var(--border); background: var(--card); }
    .hint { font-size: 12px; opacity: 0.7; }
  </style>
</head>
<body data-theme="light">
  <header class="topbar">
    <div class="brand">
      <span class="logo">â›¯</span>
      <span id="title">á€™á€¼á€±á€¬á€€á€ºá€¡á€™á€±á€›á€­á€€ ááˆá€á€ â€” á€›á€¯á€•á€ºá€›á€¾á€„á€ºá€”á€²á€·á€¡á€±á€¬á€„á€ºá€…á€½á€™á€ºá€¸ RTS + TBS</span>
    </div>
    <div class="controls">
      <select id="lang">
        <option value="my">á€™á€¼á€”á€ºá€™á€¬</option>
        <option value="en">English</option>
      </select>

      <button id="themeToggle">â˜€ï¸ Light</button>

      <label class="switch">
        <input type="checkbox" id="pauseRTS">
        <span id="pauseRTSLabel">RTS á€•á€­á€á€ºá€‘á€¬á€¸</span>
      </label>

      <label class="switch">
        <span id="speedLabel">á€¡á€™á€¼á€”á€ºá€”á€¾á€¯á€”á€ºá€¸</span>
        <input type="range" id="speed" min="0.5" max="3" step="0.25" value="1">
      </label>

      <button id="startTurnBtn">ğŸ <span id="startTurnText">Turn á€…</span></button>
      <button id="endTurnBtn">â­ <span id="endTurnText">Turn á€•á€¼á€®á€¸</span></button>

      <label class="file-label">
        <input type="file" id="geojsonFile" accept=".geojson,.json" />
        <span id="loadGeoJSONText">GeoJSON á€á€„á€º</span>
      </label>

      <select id="basemap">
        <option value="osm">OpenStreetMap</option>
        <option value="opentopo">OpenTopoMap</option>
      </select>

      <select id="mode">
        <option value="select">ğŸ–±ï¸ Select/Move</option>
        <option value="placeCity">ğŸ™ï¸ Place City</option>
        <option value="build">ğŸ—ï¸ Build Structure</option>
        <option value="train">ğŸ–ï¸ Train Soldier</option>
        <option value="assignGeneral">â­ Assign General</option>
      </select>
    </div>
  </header>

  <main>
    <div id="sidebar">
      <section class="panel">
        <h3 id="gameStateTitle">á€‚á€­á€™á€ºá€¸á€¡á€á€¼á€±á€¡á€”á€±</h3>
        <div id="gameState">
          <div><strong id="turnText">Turn</strong>: <span id="turnNumber">1</span> (<span id="dateText">á€‡á€”á€º 1800</span>)</div>
          <div><strong id="rtsText">RTS</strong>: <span id="rtsStatus">á€›á€¯á€•á€ºá€›á€¾á€„á€ºá€¡á€œá€¯á€•á€ºá€œá€¯á€•á€ºá€”á€±</span></div>
          <div><strong id="resText">á€¡á€›á€„á€ºá€¸á€¡á€™á€¼á€…á€º</strong>:
            <ul id="resourceList">
              <li>Food: <span id="resFood">0.0</span></li>
              <li>Gold: <span id="resGold">0.0</span></li>
              <li>Wood: <span id="resWood">0.0</span></li>
              <li>Iron: <span id="resIron">0.0</span></li>
            </ul>
          </div>
        </div>
      </section>

      <section class="panel">
        <h3 id="factionsTitle">Faction á€™á€»á€¬á€¸</h3>
        <ul id="factionList"></ul>
      </section>

      <section class="panel">
        <h3 id="citiesTitle">á€™á€¼á€­á€¯á€·á€™á€»á€¬á€¸</h3>
        <div class="hint" id="citiesHint">Map á€•á€±á€«á€ºá€€á€­á€¯ Place City mode á€”á€²á€· click á€œá€¯á€•á€ºá€•á€«á‹</div>
        <ul id="cityList"></ul>
      </section>

      <section class="panel">
        <h3 id="buildTitle">á€á€Šá€ºá€†á€±á€¬á€€á€ºá€”á€­á€¯á€„á€ºá€á€Šá€º</h3>
        <div class="grid-2">
          <button class="buildBtn" data-type="farm">ğŸŒ¾ Farm</button>
          <button class="buildBtn" data-type="lumber">ğŸªµ Lumber Mill</button>
          <button class="buildBtn" data-type="mine">â›ï¸ Mine</button>
          <button class="buildBtn" data-type="barracks">ğŸ° Barracks</button>
          <button class="buildBtn" data-type="fort">ğŸ›¡ï¸ Fort</button>
        </div>
        <div class="hint" id="buildHint">City á€á€…á€ºá€á€¯á€›á€½á€±á€¸á€•á€¼á€®á€¸ Build mode á€”á€²á€· á€á€Šá€ºá€†á€±á€¬á€€á€ºá€€á€¼ì„¸ìš”á‹</div>
        <div id="buildQueue"></div>
      </section>

      <section class="panel">
        <h3 id="unitsTitle">á€šá€°á€”á€…á€ºá€™á€»á€¬á€¸</h3>
        <div class="flex">
          <button id="addUnitBtn">â• <span id="addUnitText">á€šá€°á€”á€…á€ºá€‘á€Šá€·á€º</span></button>
          <button id="trainInfantryBtn" class="btn-primary">ğŸ–ï¸ <span id="trainInfantryText">Infantry á€á€»á€®á€á€€á€º</span></button>
        </div>
        <div class="hint" id="trainHint">Barracks á€•á€«á€á€±á€¬ á€™á€¼á€­á€¯á€·á€€á€­á€¯ á€›á€½á€±á€¸á€•á€¼á€®á€¸ Train mode.</div>
        <ul id="unitList"></ul>
      </section>

      <section class="panel">
        <h3 id="generalsTitle">á€—á€­á€¯á€œá€ºá€á€»á€¯á€•á€ºá€™á€»á€¬á€¸</h3>
        <div class="flex">
          <input type="text" id="newGeneralName" placeholder="General Name" />
          <button id="createGeneralBtn" class="btn-ok">â­ <span id="createGeneralText">á€—á€­á€¯á€œá€ºá€á€»á€¯á€•á€ºá€–á€”á€ºá€á€®á€¸</span></button>
        </div>
        <div class="hint" id="assignHint">Assign General mode á€á€­á€¯á€·á€•á€¼á€±á€¬á€„á€ºá€¸á€•á€¼á€®á€¸ Unit/City á€€á€­á€¯á€”á€¾á€­á€•á€ºá€•á€«á‹</div>
        <ul id="generalList"></ul>
      </section>

      <section class="panel">
        <h3 id="legendTitle">á€¡á€›á€±á€¬á€„á€º Legend</h3>
        <div id="legend"></div>
      </section>
    </div>

    <div id="map"></div>
  </main>

  <footer>
    <small id="footerText">
      Demo build. Territory GeoJSON here is placeholder (not historically accurate). Upload your own 1800-boundaries for authentic gameplay.
    </small>
  </footer>

  <!-- âœ… Leaflet JS (CDN) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity=""
    crossorigin=""
  ></script>

  <!-- Placeholder GeoJSON embedded inline -->
  <script id="placeholderGeoJSON" type="application/json">
  {
    "type": "FeatureCollection",
    "name": "north_america_1800_placeholder",
    "features": [
      {
        "type": "Feature",
        "properties": { "name": "United States (approx. east)", "factionId": "usa", "isPlaceholder": true },
        "geometry": { "type": "Polygon", "coordinates": [[[-90, 37], [-75, 37], [-75, 45], [-90, 45], [-90, 37]]] }
      },
      {
        "type": "Feature",
        "properties": { "name": "New Spain (approx.)", "factionId": "newspain", "isPlaceholder": true },
        "geometry": { "type": "Polygon", "coordinates": [[[-110, 25], [-95, 25], [-95, 32], [-110, 32], [-110, 25]]] }
      },
      {
        "type": "Feature",
        "properties": { "name": "British (Canada approx.)", "factionId": "british", "isPlaceholder": true },
        "geometry": { "type": "Polygon", "coordinates": [[[-90, 50], [-70, 50], [-70, 57], [-90, 57], [-90, 50]]] }
      },
      {
        "type": "Feature",
        "properties": { "name": "Russian America (Alaska approx.)", "factionId": "russian", "isPlaceholder": true },
        "geometry": { "type": "Polygon", "coordinates": [[[-160, 55], [-140, 55], [-140, 62], [-160, 62], [-160, 55]]] }
      },
      {
        "type": "Feature",
        "properties": { "name": "Saint-Domingue (Hispaniola West approx.)", "factionId": "saintdomingue", "isPlaceholder": true },
        "geometry": { "type": "Polygon", "coordinates": [[[-73.5, 18.5], [-72, 18.5], [-72, 19.5], [-73.5, 19.5], [-73.5, 18.5]]] }
      },
      {
        "type": "Feature",
        "properties": { "name": "Native Nations (Great Plains approx.)", "factionId": "native", "isPlaceholder": true },
        "geometry": { "type": "Polygon", "coordinates": [[[-105, 38], [-95, 38], [-95, 46], [-105, 46], [-105, 38]]] }
      }
    ]
  }
  </script>

  <script>
    // ===== i18n (á€™á€¼á€”á€ºá€™á€¬ / English) =====
    const i18n = {
      my: {
        title: "á€™á€¼á€±á€¬á€€á€ºá€¡á€™á€±á€›á€­á€€ ááˆá€á€ â€” á€›á€¯á€•á€ºá€›á€¾á€„á€ºá€”á€²á€·á€¡á€±á€¬á€„á€ºá€…á€½á€™á€ºá€¸ RTS + TBS",
        pauseRTSLabel: "RTS á€•á€­á€á€ºá€‘á€¬á€¸",
        speedLabel: "á€¡á€™á€¼á€”á€ºá€”á€¾á€¯á€”á€ºá€¸",
        startTurnText: "Turn á€…",
        endTurnText: "Turn á€•á€¼á€®á€¸",
        loadGeoJSONText: "GeoJSON á€á€„á€º",
        gameStateTitle: "á€‚á€­á€™á€ºá€¸á€¡á€á€¼á€±á€¡á€”á€±",
        turnText: "Turn",
        dateText: "á€›á€€á€ºá€…á€½á€²",
        rtsText: "RTS",
        resText: "á€¡á€›á€„á€ºá€¸á€¡á€™á€¼á€…á€º",
        factionsTitle: "Faction á€™á€»á€¬á€¸",
        unitsTitle: "á€šá€°á€”á€…á€ºá€™á€»á€¬á€¸",
        addUnitText: "á€šá€°á€”á€…á€ºá€‘á€Šá€·á€º",
        legendTitle: "á€¡á€›á€±á€¬á€„á€º Legend",
        footerText:
          "Demo build. Territory GeoJSON here is placeholder (not historically accurate). Upload your own 1800-boundaries for authentic gameplay.",
        rtsRunning: "á€›á€¯á€•á€ºá€›á€¾á€„á€ºá€¡á€œá€¯á€•á€ºá€œá€¯á€•á€ºá€”á€±",
        rtsPaused: "á€›á€¯á€•á€ºá€›á€¾á€„á€ºá€•á€­á€á€ºá€‘á€¬á€¸",
        citiesTitle: "á€™á€¼á€­á€¯á€·á€™á€»á€¬á€¸",
        citiesHint: "Map á€•á€±á€«á€ºá€€á€­á€¯ Place City mode á€”á€²á€· click á€œá€¯á€•á€ºá€•á€«á‹",
        buildTitle: "á€á€Šá€ºá€†á€±á€¬á€€á€ºá€”á€­á€¯á€„á€ºá€á€Šá€º",
        buildHint: "City á€á€…á€ºá€á€¯á€›á€½á€±á€¸á€•á€¼á€®á€¸ Build mode á€”á€²á€· á€á€Šá€ºá€†á€±á€¬á€€á€ºá€€á€¼ì„¸ìš”á‹",
        trainInfantryText: "Infantry á€á€»á€®á€á€€á€º",
        trainHint: "Barracks á€•á€«á€á€±á€¬ á€™á€¼á€­á€¯á€·á€€á€­á€¯ á€›á€½á€±á€¸á€•á€¼á€®á€¸ Train mode.",
        generalsTitle: "á€—á€­á€¯á€œá€ºá€á€»á€¯á€•á€ºá€™á€»á€¬á€¸",
        createGeneralText: "á€—á€­á€¯á€œá€ºá€á€»á€¯á€•á€ºá€–á€”á€ºá€á€®á€¸",
        assignHint: "Assign General mode á€á€­á€¯á€·á€•á€¼á€±á€¬á€„á€ºá€¸á€•á€¼á€®á€¸ Unit/City á€€á€­á€¯á€”á€¾á€­á€•á€ºá€•á€«á‹",
      },
      en: {
        title: "North America 1800 â€” Strategy (RTS + TBS)",
        pauseRTSLabel: "RTS Paused",
        speedLabel: "Speed",
        startTurnText: "Start Turn",
        endTurnText: "End Turn",
        loadGeoJSONText: "Load GeoJSON",
        gameStateTitle: "Game State",
        turnText: "Turn",
        dateText: "Date",
        rtsText: "RTS",
        resText: "Resources",
        factionsTitle: "Factions",
        unitsTitle: "Units",
        addUnitText: "Add Unit",
        legendTitle: "Color Legend",
        footerText:
          "Demo build. Territory GeoJSON here is placeholder (not historically accurate). Upload your own 1800-boundaries for authentic gameplay.",
        rtsRunning: "Running",
        rtsPaused: "Paused",
        citiesTitle: "Cities",
        citiesHint: "Use Place City mode then click on the map.",
        buildTitle: "Buildables",
        buildHint: "Select a city and use Build mode.",
        trainInfantryText: "Train Infantry",
        trainHint: "Select a city with Barracks, then Train mode.",
        generalsTitle: "Generals",
        createGeneralText: "Create General",
        assignHint: "Switch to Assign General mode then click a Unit/City.",
      },
    };

    // ===== Factions & Colors =====
    const factions = [
      { id: "usa", name_my: "á€¡á€™á€±á€›á€­á€€á€”á€ºá€•á€¼á€Šá€ºá€‘á€±á€¬á€„á€ºá€…á€¯ (ááˆá€á€)", name_en: "United States (1800)", color: "#3a86ff" },
      { id: "newspain", name_my: "New Spain (á€…á€•á€­á€”á€º)", name_en: "New Spain (Spanish Empire)", color: "#ff006e" },
      { id: "british", name_my: "á€—á€¼á€­á€á€­á€á€»á€¾ (á€€á€”á€±á€’á€«)", name_en: "British (Canada)", color: "#8338ec" },
      { id: "russian", name_my: "á€›á€¯á€›á€¾á€¬á€¸ (á€¡á€šá€ºá€œá€•á€ºá€…á€€á€¬)", name_en: "Russian (Alaska)", color: "#fb5607" },
      { id: "saintdomingue", name_my: "Saint-Domingue/á€Ÿá€±á€á€®", name_en: "Saint-Domingue/Haiti", color: "#2a9d8f" },
      { id: "native", name_my: "Native Nations", name_en: "Native Nations", color: "#6a994e" },
      { id: "neutral", name_my: "á€¡á€œá€šá€ºá€¡á€œá€á€º", name_en: "Neutral", color: "#adb5bd" },
    ];

    // ===== Game State =====
    let currentLang = "my";
    let map, baseLayers = {}, territoryLayer;
    let units = [];       // {id, type, factionId, marker, latlng, generalId, stats}
    let cities = [];      // {id, name, factionId, marker, latlng, buildings:[], buildQueue:[], prodQueue:[], generalId}
    let generals = [];    // {id, name, factionId, bonus, assignedTo: {type:'unit'|'city', id}}
    let selectedUnitId = null;
    let selectedCityId = null;

    const gameState = {
      turn: 1,
      date: { year: 1800, month: 1 },
      rtsPaused: false,
      speed: 1.0,
      resources: { food: 10, gold: 10, wood: 10, iron: 10 },
      mode: "select", // select | placeCity | build | train | assignGeneral
    };
    let rtsInterval = null;

    // ===== Building & Training Definitions =====
    const BUILDINGS = {
      farm:   { name: "Farm",   cost: {wood: 10, gold: 0, iron: 0, food: 0}, time: 8, yields: {food: 0.6} },
      lumber: { name: "Lumber", cost: {wood: 0,  gold: 0, iron: 0, food: 0}, time: 8, yields: {wood: 0.4} },
      mine:   { name: "Mine",   cost: {wood: 8,  gold: 0, iron: 0, food: 0}, time: 12, yields: {iron: 0.3, gold: 0.15} },
      barracks:{name:"Barracks",cost: {wood: 12, gold: 5, iron: 4, food: 0}, time: 14, yields: {} },
      fort:   { name: "Fort",   cost: {wood: 8,  gold: 3, iron: 6, food: 0}, time: 16, yields: {} },
    };
    const UNIT_TYPES = {
      infantry: { name: "Infantry", cost: {food: 4, wood: 2, iron: 2, gold: 1}, time: 10, stats: {atk: 5, def: 4, spd: 1.0} }
    };

    // ===== Map init (Leaflet) =====
    function initMap() {
      map = L.map("map", {
        center: [40.0, -100.0],
        zoom: 4,
        minZoom: 3,
        maxZoom: 12,
        worldCopyJump: true,
      });

      const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; OpenStreetMap contributors',
      }).addTo(map);

      const opentopo = L.tileLayer(
        "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
        { attribution: '&copy; OpenStreetMap, SRTM | &copy; OpenTopoMap' }
      );

      baseLayers = { osm, opentopo };

      territoryLayer = L.geoJSON(null, {
        style: feature => ({
          color: "#222",
          weight: 1,
          fillColor: getFactionColor(feature?.properties?.factionId),
          fillOpacity: 0.35,
        }),
        onEachFeature: (feature, layer) => {
          const name = feature.properties?.name || "Unknown";
          const factionId = feature.properties?.factionId || "neutral";
          const isPlaceholder = feature.properties?.isPlaceholder ? " (placeholder)" : "";
          layer.bindPopup(`<strong>${name}</strong><br/>Faction: ${factionId}${isPlaceholder}`);
        },
      }).addTo(map);

      // Map click for various modes
      map.on("click", onMapClick);
    }

    function getFactionColor(id) {
      const f = factions.find(f => f.id === id);
      return f ? f.color : "#adb5bd";
    }

    // ===== Legend & Lists =====
    function renderLegend() {
      const el = document.getElementById("legend");
      el.innerHTML = "";
      factions.forEach(f => {
        const item = document.createElement("div");
        item.className = "legend-item";
        item.innerHTML = `
          <span class="swatch" style="background:${f.color}"></span>
          <span>${currentLang === "my" ? f.name_my : f.name_en}</span>
        `;
        el.appendChild(item);
      });
    }

    function renderFactionList() {
      const list = document.getElementById("factionList");
      list.innerHTML = "";
      factions.forEach(f => {
        const li = document.createElement("li");
        li.textContent = currentLang === "my" ? f.name_my : f.name_en;
        list.appendChild(li);
      });
    }

    function renderCityList() {
      const list = document.getElementById("cityList");
      list.innerHTML = "";
      cities.forEach(c => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${c.name}</strong> â€” ${c.factionId} Â· buildings: ${c.buildings.length}`;
        li.style.cursor = "pointer";
        li.onclick = () => selectCity(c.id);
        list.appendChild(li);
      });
      renderBuildQueue();
    }

    function renderUnitList() {
      const list = document.getElementById("unitList");
      list.innerHTML = "";
      units.forEach(u => {
        const ll = u.marker.getLatLng();
        const g = u.generalId ? `â­G${u.generalId}` : "";
        const li = document.createElement("li");
        li.textContent = `U${u.id} (${u.type}) â€” ${u.factionId} ${g} @ ${ll.lat.toFixed(2)}, ${ll.lng.toFixed(2)}`;
        list.appendChild(li);
      });
    }

    function renderGeneralList() {
      const list = document.getElementById("generalList");
      list.innerHTML = "";
      generals.forEach(g => {
        const li = document.createElement("li");
        const assign = g.assignedTo ? ` â†’ ${g.assignedTo.type} ${g.assignedTo.id}` : " (unassigned)";
        li.textContent = `G${g.id} ${g.name} [atk+${Math.round(g.bonus.atk*100)}% def+${Math.round(g.bonus.def*100)}% prod+${Math.round(g.bonus.prod*100)}%]${assign}`;
        list.appendChild(li);
      });
    }

    // ===== Cities =====
    let cityCounter = 0;
    function placeCity(latlng, name = null, factionId = "usa") {
      const id = ++cityCounter;
      if (!name) {
        name = currentLang === "my" ? `á€™á€¼á€­á€¯á€·-${id}` : `City-${id}`;
      }
      const iconHtml = `<div class="city-badge">ğŸ™ï¸ ${name}</div>`;
      const icon = L.divIcon({ html: iconHtml, className: "city-icon", iconSize: [28,28] });
      const marker = L.marker(latlng, { icon, draggable: false }).addTo(map);
      marker.on("click", () => selectCity(id));

      const city = { id, name, factionId, marker, latlng, buildings: [], buildQueue: [], prodQueue: [], generalId: null };
      cities.push(city);
      selectedCityId = id;
      renderCityList();
    }

    function selectCity(id) {
      selectedCityId = id;
      const city = cities.find(c => c.id === id);
      if (!city) return;
      city.marker.setZIndexOffset(1000);
    }

    // ===== Build Structures =====
    function canAfford(cost) {
      return Object.entries(cost).every(([k,v]) => (gameState.resources[k] || 0) >= v);
    }
    function payCost(cost) {
      Object.entries(cost).forEach(([k,v]) => { gameState.resources[k] -= v; });
      updateResourceUI();
    }

    function queueBuild(cityId, type) {
      const city = cities.find(c => c.id === cityId);
      if (!city) return alert(currentLang === "my" ? "á€™á€¼á€­á€¯á€·á€™á€›á€½á€±á€¸á€‘á€¬á€¸á€•á€«" : "No city selected");
      const def = BUILDINGS[type];
      if (!def) return;
      if (!canAfford(def.cost)) return alert(currentLang === "my" ? "á€¡á€›á€„á€ºá€¸á€¡á€™á€¼á€…á€ºá€™á€œá€¯á€¶á€œá€±á€¬á€€á€º" : "Insufficient resources");
      payCost(def.cost);
      const item = { type, timeLeft: def.time };
      city.buildQueue.push(item);
      renderBuildQueue();
    }

    function renderBuildQueue() {
      const wrap = document.getElementById("buildQueue");
      wrap.innerHTML = "";
      const city = cities.find(c => c.id === selectedCityId);
      if (!city) return;
      city.buildQueue.forEach((it, idx) => {
        const pct = Math.max(0, Math.min(100, 100 * (1 - it.timeLeft / BUILDINGS[it.type].time)));
        const div = document.createElement("div");
        div.innerHTML = `<strong>${BUILDINGS[it.type].name}</strong>
          <div class="progress"><span style="width:${pct}%"></span></div>`;
        wrap.appendChild(div);
      });
    }

    function processCityQueues(dt) {
      cities.forEach(city => {
        const prodBonus = city.generalId ? (generals.find(g => g.id === city.generalId)?.bonus?.prod || 0) : 0;

        // Apply building yields
        city.buildings.forEach(b => {
          const y = BUILDINGS[b].yields || {};
          Object.entries(y).forEach(([k, base]) => {
            const inc = base * gameState.speed * (1 + prodBonus);
            gameState.resources[k] = (gameState.resources[k] || 0) + inc;
          });
        });

        // Build queue progress
        if (city.buildQueue.length > 0) {
          const current = city.buildQueue[0];
          current.timeLeft -= dt * gameState.speed;
          if (current.timeLeft <= 0) {
            city.buildings.push(current.type);
            city.buildQueue.shift();
            renderCityList();
          }
        }

        // Production queue (training units)
        if (city.prodQueue.length > 0) {
          const job = city.prodQueue[0];
          job.timeLeft -= dt * gameState.speed * (1 + prodBonus);
          if (job.timeLeft <= 0) {
            addUnit(city.latlng, city.factionId, "infantry");
            city.prodQueue.shift();
            renderUnitList();
          }
        }
      });
      updateResourceUI();
      renderBuildQueue();
    }

    // ===== Training (Units) =====
    function queueTrainInfantry() {
      const city = cities.find(c => c.id === selectedCityId);
      if (!city) return alert(currentLang === "my" ? "á€™á€¼á€­á€¯á€·á€™á€›á€½á€±á€¸á€‘á€¬á€¸á€•á€«" : "No city selected");
      if (!city.buildings.includes("barracks")) {
        return alert(currentLang === "my" ? "Barracks á€™á€›á€¾á€­á€•á€«" : "Barracks required");
      }
      const def = UNIT_TYPES.infantry;
      if (!canAfford(def.cost)) return alert(currentLang === "my" ? "á€¡á€›á€„á€ºá€¸á€¡á€™á€¼á€…á€ºá€™á€œá€¯á€¶á€œá€±á€¬á€€á€º" : "Insufficient resources");
      payCost(def.cost);
      city.prodQueue.push({ type: "infantry", timeLeft: def.time });
      renderBuildQueue();
    }

    // ===== Units =====
    let unitCounter = 0;
    function addUnit(latlng = [39.0, -95.0], factionId = "usa", type = "infantry") {
      const id = ++unitCounter;
      const iconHtml = `<div class="unit-badge">U${id}</div>`;
      const icon = L.divIcon({ html: iconHtml, className: "unit-icon", iconSize: [24,24] });
      const marker = L.marker(latlng, { icon, draggable: false }).addTo(map);

      marker.on("click", () => {
        selectedUnitId = id;
        highlightSelected(marker);
      });

      // Move selected unit on map click
      map.on("click", e => {
        if (gameState.mode === "select" && selectedUnitId === id) {
          moveUnit(marker, e.latlng);
        }
      });

      const baseStats = UNIT_TYPES[type].stats;
      const unit = { id, type, factionId, marker, latlng, generalId: null, stats: {...baseStats} };
      units.push(unit);
      renderUnitList();
    }

    function moveUnit(marker, targetLatLng) {
      const start = marker.getLatLng();
      const steps = Math.max(10, Math.floor(40 / gameState.speed));
      let i = 0;
      const dx = (targetLatLng.lat - start.lat) / steps;
      const dy = (targetLatLng.lng - start.lng) / steps;
      const interval = setInterval(() => {
        i++;
        marker.setLatLng([start.lat + dx * i, start.lng + dy * i]);
        if (i >= steps) clearInterval(interval);
      }, 25);
    }

    function highlightSelected(marker) {
      marker.setZIndexOffset(1000);
    }

    // ===== Generals =====
    let generalCounter = 0;
    function createGeneral(nameInput) {
      const id = ++generalCounter;
      const name = (nameInput || "").trim() || (currentLang === "my" ? `á€—á€­á€¯á€œá€º-${id}` : `General-${id}`);
      const bonus = {
        atk: 0.10 + Math.random()*0.10,  // 10-20%
        def: 0.10 + Math.random()*0.10,
        prod: 0.10 + Math.random()*0.20, // 10-30%
      };
      const g = { id, name, factionId: "usa", bonus, assignedTo: null };
      generals.push(g);
      renderGeneralList();
    }

    function assignGeneral(target) {
      const available = generals.find(g => !g.assignedTo);
      if (!available) {
        return alert(currentLang === "my" ? "á€—á€­á€¯á€œá€ºá€á€»á€¯á€•á€ºá€™á€›á€¾á€­/á€¡á€¬á€¸á€œá€•á€ºá€™á€›á€¾á€­" : "No free generals");
      }
      available.assignedTo = target;
      if (target.type === "unit") {
        const unit = units.find(u => u.id === target.id);
        if (unit) {
          unit.generalId = available.id;
          unit.stats.atk *= (1 + available.bonus.atk);
          unit.stats.def *= (1 + available.bonus.def);
          unit.stats.spd *= (1 + 0.05);
        }
      } else if (target.type === "city") {
        const city = cities.find(c => c.id === target.id);
        if (city) city.generalId = available.id;
      }
      renderGeneralList();
      renderUnitList();
      renderCityList();
    }

    // ===== RTS Loop =====
    function startRTSLoop() {
      if (rtsInterval) clearInterval(rtsInterval);
      const tickMs = 1000; // base 1s
      rtsInterval = setInterval(() => {
        if (gameState.rtsPaused) return;
        const s = gameState.speed;
        gameState.resources.food += 0.2 * s;
        gameState.resources.gold += 0.1 * s;
        gameState.resources.wood += 0.2 * s;
        gameState.resources.iron += 0.05 * s;

        processCityQueues(tickMs / 1000); // dt seconds

        updateResourceUI();
      }, tickMs);
    }

    function updateResourceUI() {
      document.getElementById("resFood").textContent = gameState.resources.food.toFixed(1);
      document.getElementById("resGold").textContent = gameState.resources.gold.toFixed(1);
      document.getElementById("resWood").textContent = gameState.resources.wood.toFixed(1);
      document.getElementById("resIron").textContent = gameState.resources.iron.toFixed(1);
    }

    function nextMonth() {
      gameState.date.month++;
      if (gameState.date.month > 12) {
        gameState.date.month = 1;
        gameState.date.year++;
      }
      document.getElementById("dateText").textContent = monthName(gameState.date.month) + " " + gameState.date.year;
    }

    function monthName(m) {
      const en = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][m-1];
      if (currentLang === "my") {
        const my = ["á€‡á€”á€º","á€–á€±","á€™á€á€º","á€§","á€™á€±","á€‡á€½á€”á€º","á€‡á€°","á€©","á€…á€€á€º","á€¡á€±á€¬á€€á€º","á€”á€­á€¯","á€’á€®"][m-1];
        return my;
      }
      return en;
    }

    function endTurn() {
      gameState.resources.food = Math.max(0, gameState.resources.food - 0.8 * units.length);
      gameState.resources.gold = Math.max(0, gameState.resources.gold - 0.2 * units.length);
      gameState.turn++;
      document.getElementById("turnNumber").textContent = gameState.turn;
      nextMonth();
      updateResourceUI();
    }

    // ===== GeoJSON Load =====
    function loadPlaceholderTerritories() {
      try {
        const raw = document.getElementById("placeholderGeoJSON").textContent;
        const gj = JSON.parse(raw);
        territoryLayer.clearLayers();
        territoryLayer.addData(gj);
      } catch (e) {
        console.warn("Failed to load placeholder territories:", e);
      }
    }

    function handleGeoJSONFileInput(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const gj = JSON.parse(reader.result);
          territoryLayer.clearLayers();
          territoryLayer.addData(gj);
          alert(currentLang === "my" ? "GeoJSON á€á€„á€ºá€•á€¼á€®á€¸!" : "GeoJSON loaded.");
        } catch (e) {
          alert(currentLang === "my" ? "GeoJSON á€™á€™á€¾á€”á€ºá€•á€«!" : "Invalid GeoJSON.");
        }
      };
      reader.readAsText(file);
    }

    // ===== Language & Theme =====
    function applyLang() {
      const t = i18n[currentLang];
      document.getElementById("title").textContent = t.title;
      document.getElementById("pauseRTSLabel").textContent = t.pauseRTSLabel;
      document.getElementById("speedLabel").textContent = t.speedLabel;
      document.getElementById("startTurnText").textContent = t.startTurnText;
      document.getElementById("endTurnText").textContent = t.endTurnText;
      document.getElementById("loadGeoJSONText").textContent = t.loadGeoJSONText;
      document.getElementById("gameStateTitle").textContent = t.gameStateTitle;
      document.getElementById("turnText").textContent = t.turnText;
      document.getElementById("dateText").textContent = monthName(gameState.date.month) + " " + gameState.date.year;
      document.getElementById("rtsText").textContent = t.rtsText;
      document.getElementById("resText").textContent = t.resText;
      document.getElementById("factionsTitle").textContent = t.factionsTitle;
      document.getElementById("unitsTitle").textContent = t.unitsTitle;
      document.getElementById("addUnitText").textContent = t.addUnitText;
      document.getElementById("legendTitle").textContent = t.legendTitle;
      document.getElementById("citiesTitle").textContent = t.citiesTitle;
      document.getElementById("citiesHint").textContent = t.citiesHint;
      document.getElementById("buildTitle").textContent = t.buildTitle;
      document.getElementById("buildHint").textContent = t.buildHint;
      document.getElementById("trainInfantryText").textContent = t.trainInfantryText;
      document.getElementById("trainHint").textContent = t.trainHint;
      document.getElementById("generalsTitle").textContent = t.generalsTitle;
      document.getElementById("createGeneralText").textContent = t.createGeneralText;
      document.getElementById("assignHint").textContent = t.assignHint;

      document.querySelector("footer small").textContent = t.footerText;
      document.getElementById("rtsStatus").textContent =
        gameState.rtsPaused ? t.rtsPaused : t.rtsRunning;
      renderFactionList();
      renderLegend();
      renderCityList();
      renderUnitList();
      renderGeneralList();
    }

    function toggleTheme() {
      const body = document.body;
      const current = body.getAttribute("data-theme");
      const next = current === "light" ? "dark" : "light";
      body.setAttribute("data-theme", next);
      document.getElementById("themeToggle").textContent = next === "light" ? "â˜€ï¸ Light" : "ğŸŒ™ Dark";
    }

    // ===== Basemap Switch =====
    function applyBasemap(value) {
      Object.values(baseLayers).forEach(layer => {
        if (map.hasLayer(layer)) map.removeLayer(layer);
      });
      baseLayers[value].addTo(map);
    }

    // ===== Map Click Mode Handling =====
    function onMapClick(e) {
      const mode = gameState.mode;
      if (mode === "placeCity") {
        const name = prompt(currentLang === "my" ? "á€™á€¼á€­á€¯á€·á€¡á€™á€Šá€º" : "City name");
        placeCity(e.latlng, name, "usa");
      } else if (mode === "build") {
        const city = cities.find(c => c.id === selectedCityId);
        if (!city) return alert(currentLang === "my" ? "á€¡á€›á€„á€º á€™á€¼á€­á€¯á€·á€›á€½á€±á€¸á€•á€«" : "Select a city first");
        alert(currentLang === "my" ? "Build á€¡á€™á€»á€­á€¯á€¸á€¡á€…á€¬á€¸á€€á€­á€¯ sidebar á€™á€¾ á€›á€½á€±á€¸á€•á€«" : "Choose a build type in sidebar.");
      } else if (mode === "train") {
        queueTrainInfantry();
      } else if (mode === "assignGeneral") {
        if (selectedUnitId) assignGeneral({type: "unit", id: selectedUnitId});
        else if (selectedCityId) assignGeneral({type: "city", id: selectedCityId});
        else alert(currentLang === "my" ? "Unit/City á€›á€½á€±á€¸á€•á€«" : "Select a Unit or City");
      } else {
        // select/move default handled via unit marker click
      }
    }

    // ===== Boot =====
    window.addEventListener("DOMContentLoaded", () => {
      const savedLang = localStorage.getItem("lang");
      if (savedLang) currentLang = savedLang;
      document.getElementById("lang").value = currentLang;

      initMap();
      loadPlaceholderTerritories();
      startRTSLoop();

      addUnit([39.0, -95.0], "usa", "infantry");

      document.getElementById("lang").addEventListener("change", e => {
        currentLang = e.target.value;
        localStorage.setItem("lang", currentLang);
        applyLang();
      });
      applyLang();

      document.getElementById("themeToggle").addEventListener("click", toggleTheme);

      document.getElementById("pauseRTS").addEventListener("change", e => {
        gameState.rtsPaused = e.target.checked;
        document.getElementById("rtsStatus").textContent =
          gameState.rtsPaused ? i18n[currentLang].rtsPaused : i18n[currentLang].rtsRunning;
      });

      document.getElementById("speed").addEventListener("input", e => {
        gameState.speed = parseFloat(e.target.value);
      });

      document.getElementById("startTurnBtn").addEventListener("click", () => {
        alert(currentLang === "my" ? "Turn á€…á€á€„á€ºá€•á€¼á€®!" : "Turn started!");
      });

      document.getElementById("endTurnBtn").addEventListener("click", endTurn);

      document.getElementById("addUnitBtn").addEventListener("click", () => {
        addUnit([41.0, -87.0], "usa", "infantry");
      });

      document.getElementById("trainInfantryBtn").addEventListener("click", queueTrainInfantry);

      document.querySelectorAll(".buildBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const type = btn.dataset.type;
          if (!selectedCityId) {
            alert(currentLang === "my" ? "á€™á€¼á€­á€¯á€·á€›á€½á€±á€¸á€•á€«" : "Select a city first");
            return;
          }
          queueBuild(selectedCityId, type);
        });
      });

      document.getElementById);
      });

      document.getElementById("basemap").addEventListener("change", e => {
        applyBasemap(e.target.value);
      });

      document.getElementById("mode").addEventListener("change", e => {
        gameState.mode = e.target.value;
      });

      document.getElementById("createGeneralBtn").addEventListener("click", () => {
        const name = document.getElementById("newGeneralName").value;
        createGeneral(name);
        document.getElementById("newGeneralName").value = "";
      });
    });
  </script>
</body>
</html>
